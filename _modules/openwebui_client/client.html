

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>openwebui_client.client &mdash; openwebui-client 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=37f418d5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            openwebui-client
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#installation-from-pypi">Installation from PyPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#installation-from-source">Installation from Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#development-installation">Development Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage.html#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#direct-configuration">Direct Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage.html#basic-usage">Basic Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#chat-completions">Chat Completions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#chat-completions-with-files">Chat Completions with Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage.html#file-management">File Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#upload-a-single-file">Upload a Single File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage.html#upload-multiple-files">Upload Multiple Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#basic-chat-completion">Basic Chat Completion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#chat-completion-with-files">Chat Completion with Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#using-function-calling-tools">Using Function Calling / Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../examples.html#direct-tool-usage">Direct Tool Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples.html#using-the-tool-registry">Using the Tool Registry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#file-upload-and-management">File Upload and Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-openwebui_client.client">Client</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIChat"><code class="docutils literal notranslate"><span class="pre">OpenWebUIChat</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIChat.completions"><code class="docutils literal notranslate"><span class="pre">OpenWebUIChat.completions()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIClient"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIClient.__init__"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIClient.chat"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.chat()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIClient.files"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.client.OpenWebUIClient.chat_with_tools"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.chat_with_tools()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#chat-completions">Chat Completions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#openwebui_client.completions.OpenWebUICompletions"><code class="docutils literal notranslate"><span class="pre">OpenWebUICompletions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.completions.OpenWebUICompletions.__init__"><code class="docutils literal notranslate"><span class="pre">OpenWebUICompletions.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.completions.OpenWebUICompletions.create"><code class="docutils literal notranslate"><span class="pre">OpenWebUICompletions.create()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-openwebui_client.files">Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#openwebui_client.files.OpenWebUIFiles"><code class="docutils literal notranslate"><span class="pre">OpenWebUIFiles</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.files.OpenWebUIFiles.from_paths"><code class="docutils literal notranslate"><span class="pre">OpenWebUIFiles.from_paths()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.files.OpenWebUIFiles.from_path"><code class="docutils literal notranslate"><span class="pre">OpenWebUIFiles.from_path()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#core-module">Core Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#openwebui_client.OpenWebUIClient"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.OpenWebUIClient.__init__"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.OpenWebUIClient.chat"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.chat()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.OpenWebUIClient.chat_with_tools"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.chat_with_tools()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api.html#openwebui_client.OpenWebUIClient.files"><code class="docutils literal notranslate"><span class="pre">OpenWebUIClient.files()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#development-setup">Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#code-style">Code Style</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#running-tests">Running Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#building-documentation">Building Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#submitting-changes">Submitting Changes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#changelog">Changelog</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#id1">[0.1.0] - 2025-05-27</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../changelog.html#added">Added</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">openwebui-client</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">openwebui_client.client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for openwebui_client.client</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;OpenWebUI client for interacting with the OpenWebUI API.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai._compat</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai.resources.chat</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chat</span> <span class="k">as</span> <span class="n">OpenAIChat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai.types.chat.chat_completion</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatCompletion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai.types.chat.chat_completion_message_param</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatCompletionMessageParam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai.types.chat.chat_completion_tool_message_param</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ChatCompletionToolMessageParam</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.completions</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenWebUICompletions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenWebUIFiles</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolsRegistry</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<div class="viewcode-block" id="OpenWebUIChat">
<a class="viewcode-back" href="../../api.html#openwebui_client.client.OpenWebUIChat">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenWebUIChat</span><span class="p">(</span><span class="n">OpenAIChat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Chat class that uses OpenWebUICompletions.&quot;&quot;&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">completions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenWebUICompletions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OpenWebUICompletions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">)</span></div>



<div class="viewcode-block" id="OpenWebUIClient">
<a class="viewcode-back" href="../../api.html#openwebui_client.client.OpenWebUIClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenWebUIClient</span><span class="p">(</span><span class="n">OpenAI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client for interacting with the OpenWebUI API.</span>

<span class="sd">    This client extends the OpenAI client with OpenWebUI-specific</span>
<span class="sd">    features like file attachments in chat completions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OpenWebUIClient.__init__">
<a class="viewcode-back" href="../../api.html#openwebui_client.client.OpenWebUIClient.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:5000&quot;</span><span class="p">,</span>
        <span class="n">default_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the OpenWebUI client.</span>

<span class="sd">        Args:</span>
<span class="sd">            api_key: Your OpenWebUI API key</span>
<span class="sd">            base_url: Base URL for the API (defaults to OpenWebUI&#39;s local instance)</span>
<span class="sd">            default_model: Default model to use for completions</span>
<span class="sd">            **kwargs: Additional arguments to pass to the OpenAI client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># OpenWebUI has different endpoint patterns than OpenAI</span>
        <span class="c1"># Remove trailing slash if present</span>
        <span class="k">if</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Initialize the parent OpenAI class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Store additional configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span> <span class="o">=</span> <span class="n">default_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_registry</span> <span class="o">=</span> <span class="n">ToolsRegistry</span><span class="p">()</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenWebUIChat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the custom OpenWebUIChat instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OpenWebUIChat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenWebUIFiles</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OpenWebUIFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="OpenWebUIClient.chat_with_tools">
<a class="viewcode-back" href="../../api.html#openwebui_client.client.OpenWebUIClient.chat_with_tools">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">chat_with_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionMessageParam</span><span class="p">],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tool_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a chat completion request and handle tool calls automatically.</span>

<span class="sd">        This will automatically execute tool calls and include their results</span>
<span class="sd">        in subsequent API calls until the model returns a final response.</span>

<span class="sd">        Args:</span>
<span class="sd">            messages: List of message dictionaries with &#39;role&#39; and &#39;content&#39; keys</span>
<span class="sd">            tools: List of tool names to use (None for all registered tools)</span>
<span class="sd">            tool_params: Optional parameters to pass to the tools when they are called</span>
<span class="sd">            model: Model to use (defaults to the client&#39;s default model)</span>
<span class="sd">            max_tool_calls: Maximum number of tool call rounds to allow</span>
<span class="sd">            files: Optional list of Path objects to files that should be included with the request</span>

<span class="sd">        Returns:</span>
<span class="sd">            The final assistant message content (str) after all tool calls are processed</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the maximum number of tool calls is exceeded</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; client = OpenWebUIClient()</span>
<span class="sd">            &gt;&gt;&gt; client.tool_registry.register(get_weather)</span>
<span class="sd">            &gt;&gt;&gt; response = client.chat_with_tools(</span>
<span class="sd">            ...     messages=[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What&#39;s the weather in Paris?&quot;}],</span>
<span class="sd">            ...     max_tool_calls=3</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; print(response)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize tool_params if not provided</span>
        <span class="k">if</span> <span class="n">tool_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">conversation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionMessageParam</span><span class="p">]</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">file_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">from_paths</span><span class="p">([(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>

        <span class="c1"># Conversation is now a list that we can mutate</span>
        <span class="n">tool_call_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get tools from the registry</span>
        <span class="n">all_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_registry</span><span class="o">.</span><span class="n">get_openai_tools</span><span class="p">()</span>

        <span class="c1"># Filter tools if specific ones were requested</span>
        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">tool_schemas</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tool</span>
                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">all_tools</span>
                <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use all registered tools</span>
            <span class="n">tool_schemas</span> <span class="o">=</span> <span class="n">all_tools</span>

        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting chat with tools&quot;</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Available tools: </span><span class="si">{</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tool_schemas</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">tool_schemas</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial messages: </span><span class="si">{</span><span class="n">conversation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">tool_call_count</span> <span class="o">&lt;</span> <span class="n">max_tool_calls</span><span class="p">:</span>
            <span class="c1"># Get the next response from the model</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Sending request to model (attempt </span><span class="si">{</span><span class="n">tool_call_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_tool_calls</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Messages: </span><span class="si">{</span><span class="n">conversation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using model: </span><span class="si">{</span><span class="n">model</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tools: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_schemas</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2"> if tool_schemas else &#39;None&#39;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Debug log the tool dictionaries</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool dictionaries: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_schemas</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Also log the original tool schemas for comparison</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">conversation</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="n">tool_schemas</span><span class="p">,</span>
                <span class="s2">&quot;tool_choice&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">file_refs</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Not running in stream mode, this should never fail. Here for type safety.</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ChatCompletion</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>

            <span class="c1"># If there are no tool calls, we&#39;re done</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No tool calls in response, ending conversation&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Not running in stream mode, this should never fail. Here for type safety.</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ChatCompletion</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>

            <span class="c1"># If there are no tool calls, we&#39;re done</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No tool calls in response, ending conversation&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Process tool calls</span>
            <span class="n">tool_call_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing tool call </span><span class="si">{</span><span class="n">tool_call_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_tool_calls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span>
                <span class="n">non_ai_params</span> <span class="o">=</span> <span class="n">tool_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling tool: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arguments: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">non_ai_params</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-AI parameters: </span><span class="si">{</span><span class="n">non_ai_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Execute the tool</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Calling tool: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> with args: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_registry</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span>
                        <span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">),</span>
                        <span class="n">non_ai_params</span><span class="o">=</span><span class="n">non_ai_params</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">result_str</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">result</span>
                    <span class="p">)</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> returned: </span><span class="si">{</span><span class="n">result_str</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result_str</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">200</span>
                        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> returned: </span><span class="si">{</span><span class="n">result_str</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">result_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error calling tool </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                <span class="c1"># Add the tool response to the conversation</span>
                <span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChatCompletionToolMessageParam</span><span class="p">(</span>
                        <span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">result_str</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum number of tool calls (</span><span class="si">{</span><span class="n">max_tool_calls</span><span class="si">}</span><span class="s2">) exceeded&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Marc Durepos.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>